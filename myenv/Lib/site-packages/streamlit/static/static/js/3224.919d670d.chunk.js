"use strict";(self.webpackChunk_streamlit_app=self.webpackChunk_streamlit_app||[]).push([[3224],{53224:(e,t,n)=>{n.r(t),n.d(t,{default:()=>ye});var r=n(58878),a=n(8151),i=n(19613),l=n(56146),o=n(18364),s=n(95241),d=n(71034),c=n.n(d),u=n(34752),g=n(70691),p=n(25571),f=n(58144),h=n(50609),m=n.n(h),y=n(29669),b=n(67253);var w=n(93480),v=n(997),x=n(70474),C=n(35526);const j=e=>{var t;let{widgetMgr:n,id:a,formId:i,key:l,defaultValue:o}=e;(0,r.useEffect)((()=>{const e=n.getElementState(a,l);(0,p.hX)(e)&&(0,p.se)(o)&&n.setElementState(a,l,o)}),[n,a,l,o]);const[s,d]=(0,r.useState)(null!==(t=n.getElementState(a,l))&&void 0!==t?t:o),c=(0,r.useCallback)((e=>{n.setElementState(a,l,e),d(e)}),[n,a,l]),g=(0,r.useMemo)((()=>({formId:i||""})),[i]),f=(0,r.useCallback)((()=>c(o)),[o,c]);return(0,u.X)({element:g,widgetMgr:n,onFormCleared:f}),[s,c]};var k=n(84152),S=n(55562);const A=(e,t)=>{const{libConfig:{enforceDownloadInNewTab:n=!1}}=r.useContext(k.n);return(0,r.useCallback)((()=>{if(!e)return;const r=(0,S.A)({enforceDownloadInNewTab:n,url:e,filename:t});r.style.display="none",document.body.appendChild(r),r.click(),document.body.removeChild(r)}),[e,n,t])};var U=n(89653),I=n(37888);const R=(0,U.A)("div",{target:"e12wn80j15"})(""),P=(0,U.A)("div",{target:"e12wn80j14"})((e=>{let{theme:t}=e;return{height:t.sizes.largestElementHeight,width:"100%",background:t.colors.secondaryBg,borderRadius:t.radii.default,marginBottom:t.spacing.twoXS,display:"flex",alignItems:"center",position:"relative",paddingLeft:t.spacing.xs,paddingRight:t.spacing.sm}}),""),E=(0,U.A)("div",{target:"e12wn80j13"})({name:"82a6rk",styles:"flex:1"}),T=(0,U.A)("div",{target:"e12wn80j12"})((e=>{let{show:t}=e;return{display:t?"block":"none"}}),""),L=(0,U.A)("span",{target:"e12wn80j11"})((e=>{let{theme:t,isPlayingOrRecording:n}=e;return{margin:t.spacing.sm,fontFamily:t.fonts.monospace,color:n?t.colors.bodyText:t.colors.fadedText60,backgroundColor:t.colors.secondaryBg,fontSize:t.fontSizes.sm}}),""),M=(0,U.A)("div",{target:"e12wn80j10"})({name:"1kyw74z",styles:"width:100%;text-align:center;overflow:hidden"}),z=(0,U.A)("span",{target:"e12wn80j9"})((e=>{let{theme:t}=e;return{color:t.colors.bodyText}}),""),F=(0,U.A)("a",{target:"e12wn80j8"})(""),W=(0,U.A)("div",{target:"e12wn80j7"})((e=>{let{theme:t}=e;return{height:t.sizes.largestElementHeight,display:"flex",justifyContent:"center",alignItems:"center"}}),""),B=(0,U.A)("div",{target:"e12wn80j6"})((e=>{let{theme:t}=e;const n="0.625em";return{opacity:.2,width:"100%",height:n,backgroundSize:n,backgroundImage:`radial-gradient(${t.colors.fadedText10} 40%, transparent 40%)`,backgroundRepeat:"repeat"}}),""),X=(0,U.A)("span",{target:"e12wn80j5"})((e=>{let{theme:t}=e;return{"& > button":{color:t.colors.primary,padding:t.spacing.threeXS},"& > button:hover, & > button:focus":{color:t.colors.red}}}),""),O=(0,U.A)("span",{target:"e12wn80j4"})((e=>{let{theme:t}=e;return{"& > button":{padding:t.spacing.threeXS,color:t.colors.fadedText40},"& > button:hover, & > button:focus":{color:t.colors.primary}}}),""),V=(0,U.A)("span",{target:"e12wn80j3"})((e=>{let{theme:t}=e;return{"& > button":{padding:t.spacing.threeXS,color:t.colors.fadedText60},"& > button:hover, & > button:focus":{color:t.colors.bodyText}}}),""),D=(0,U.A)("div",{target:"e12wn80j2"})((e=>{let{theme:t}=e;return{display:"flex",justifyContent:"center",alignItems:"center",flexGrow:0,flexShrink:1,padding:t.spacing.xs,gap:t.spacing.twoXS,marginRight:t.spacing.twoXS}}),""),N=(0,U.A)("div",{target:"e12wn80j1"})((e=>{let{theme:t}=e;return{marginLeft:t.spacing.sm}}),""),_=(0,U.A)(I.x,{target:"e12wn80j0"})((e=>{let{theme:t}=e;return{fontSize:t.fontSizes.sm,width:t.sizes.spinnerSize,height:t.sizes.spinnerSize,borderWidth:t.sizes.spinnerThickness,radius:t.radii.md,justifyContents:"center",padding:t.spacing.none,margin:t.spacing.none,borderColor:t.colors.borderColor,borderTopColor:t.colors.primary,flexGrow:0,flexShrink:0}}),"");var G=n(39095),H=n(90782);const K=()=>(0,H.jsxs)(M,{children:[(0,H.jsx)(z,{children:"This app would like to use your microphone."})," ",(0,H.jsx)(F,{href:G.ML,children:"Learn how to allow access."})]}),$=()=>(0,H.jsx)(W,{children:(0,H.jsx)(B,{})}),Y="00:00",Z=e=>new Date(e).toLocaleTimeString(void 0,{minute:"2-digit",second:"2-digit"});var q=n(96626),J=n(34783),Q=n(37789),ee=n(14757),te=n(88685),ne=n(36459),re=n(84720),ae=n(64611);const ie=e=>{let{onClick:t,disabled:n,ariaLabel:r,iconContent:a}=e;return(0,H.jsx)(ne.Ay,{kind:re.KX.BORDERLESS_ICON,onClick:t,disabled:n,"aria-label":r,fluidWidth:!0,"data-testid":"stAudioInputActionButton",children:(0,H.jsx)(ae.A,{content:a,size:"lg",color:"inherit"})})},le=e=>{let{disabled:t,stopRecording:n}=e;return(0,H.jsx)(X,{children:(0,H.jsx)(ie,{onClick:n,disabled:t,ariaLabel:"Stop recording",iconContent:J.X})})},oe=e=>{let{disabled:t,isPlaying:n,onClickPlayPause:r}=e;return(0,H.jsx)(V,{children:n?(0,H.jsx)(ie,{onClick:r,disabled:t,ariaLabel:"Pause",iconContent:Q.v}):(0,H.jsx)(ie,{onClick:r,disabled:t,ariaLabel:"Play",iconContent:ee.S})})},se=e=>{let{disabled:t,startRecording:n}=e;return(0,H.jsx)(O,{children:(0,H.jsx)(ie,{onClick:n,disabled:t,ariaLabel:"Record",iconContent:q.G})})},de=e=>{let{onClick:t}=e;return(0,H.jsx)(V,{children:(0,H.jsx)(ie,{disabled:!1,onClick:t,ariaLabel:"Reset",iconContent:te.C})})},ce=e=>{let{disabled:t,isRecording:n,isPlaying:r,isUploading:a,isError:i,recordingUrlExists:l,startRecording:o,stopRecording:s,onClickPlayPause:d,onClear:c}=e;return i?(0,H.jsx)(D,{children:(0,H.jsx)(de,{onClick:c})}):a?(0,H.jsx)(D,{children:(0,H.jsx)(_,{"aria-label":"Uploading"})}):(0,H.jsxs)(D,{children:[n?(0,H.jsx)(le,{disabled:t,stopRecording:s}):(0,H.jsx)(se,{disabled:t,startRecording:o}),l&&(0,H.jsx)(oe,{disabled:t,isPlaying:r,onClickPlayPause:d})]})},ue=(0,r.memo)(ce);var ge=n(84996);function pe(e,t,n){for(let r=0;r<n.length;r++,t+=2){const a=Math.max(-1,Math.min(1,n[r]));e.setInt16(t,a<0?32768*a:32767*a,!0)}}const fe=async function(e){const t=new window.AudioContext,n=await e.arrayBuffer();let r;try{r=await t.decodeAudioData(n)}catch(u){return void(0,ge.vV)(u)}const a=r.numberOfChannels,i=r.sampleRate,l=r.length*a*2+44,o=new ArrayBuffer(l),s=new DataView(o),d={0:{type:"string",value:"RIFF"},4:{type:"uint32",value:36+2*r.length*a},8:{type:"string",value:"WAVE"},12:{type:"string",value:"fmt "},16:{type:"uint32",value:16},20:{type:"uint16",value:1},22:{type:"uint16",value:a},24:{type:"uint32",value:i},28:{type:"uint32",value:i*a*2},32:{type:"uint16",value:2*a},34:{type:"uint16",value:16},36:{type:"string",value:"data"},40:{type:"uint32",value:r.length*a*2}};Object.entries(d).forEach((e=>{let[t,{type:n,value:r}]=e;const a=parseInt(t,10);"string"===n?function(e,t,n){for(let r=0;r<n.length;r++)e.setUint8(t+r,n.charCodeAt(r))}(s,a,r):"uint32"===n?s.setUint32(a,r,!0):"uint16"===n&&s.setUint16(a,r,!0)}));for(let g=0;g<a;g++)pe(s,44+g*r.length*2,r.getChannelData(g));const c=new Uint8Array(o);return new Blob([c],{type:"audio/wav"})},he=()=>(0,H.jsx)(M,{children:(0,H.jsx)(z,{children:"An error has occurred, please try again."})}),me=e=>{var t;let{element:n,uploadClient:d,widgetMgr:h,fragmentId:k,disabled:S}=e;const U=(0,a.u)(),I=(0,C.Z)(U),[M,z]=(0,r.useState)(null),F=r.useRef(null),[W,B]=j({widgetMgr:h,id:n.id,key:"deleteFileUrl",defaultValue:null}),[X,O]=(0,r.useState)(null),[V,D]=(0,r.useState)([]),[_,G]=(0,r.useState)(null),[q,J]=j({widgetMgr:h,id:n.id,key:"recordingUrl",defaultValue:null}),[,Q]=(0,r.useState)(0),ee=()=>{Q((e=>e+1))},[te,ne]=(0,r.useState)(Y),[re,ae]=j({widgetMgr:h,id:n.id,formId:n.formId,key:"recordingTime",defaultValue:Y}),[ie,le]=(0,r.useState)(!1),[oe,se]=(0,r.useState)(!1),[de,ce]=(0,r.useState)(!1),[ge,pe]=(0,r.useState)(!1),[me,ye]=(0,r.useState)(!1),be=n.id,we=n.formId,ve=(0,r.useCallback)((async e=>{let t;if(pe(!0),(0,p.se)(we)&&h.setFormsWithUploadsInProgress(new Set([we])),t="audio/wav"===e.type?e:await fe(e),!t)return void ye(!0);const n=URL.createObjectURL(t),r=new File([t],"audio.wav",{type:t.type});J(n),(async e=>{let{files:t,uploadClient:n,widgetMgr:r,widgetInfo:a,fragmentId:i}=e,l=[];try{l=await n.fetchFileURLs(t)}catch(c){return{successfulUploads:[],failedUploads:t.map((e=>({file:e,error:(0,b.$)(c)})))}}const o=m()(t,l),s=[],d=[];return await Promise.all(o.map((async e=>{let[t,r]=e;if(!t||!r||!r.uploadUrl||!r.fileId)return{file:t,fileUrl:r,error:new Error("No upload URL found")};try{await n.uploadFile({id:r.fileId,formId:a.formId||""},r.uploadUrl,t),s.push({fileUrl:r,file:t})}catch(c){const n=(0,b.$)(c);d.push({file:t,error:n})}}))),r.setFileUploaderStateValue(a,new y.qX({uploadedFileInfo:s.map((e=>{let{file:t,fileUrl:n}=e;return new y.HY({fileId:n.fileId,fileUrls:n,name:t.name,size:t.size})}))}),{fromUi:!0},i),{successfulUploads:s,failedUploads:d}})({files:[r],uploadClient:d,widgetMgr:h,widgetInfo:{id:be,formId:we},fragmentId:k}).then((e=>{let{successfulUploads:t,failedUploads:n}=e;if(n.length>0)return void ye(!0);const r=t[0];r&&r.fileUrl.deleteUrl&&B(r.fileUrl.deleteUrl)})).finally((()=>{(0,p.se)(we)&&h.setFormsWithUploadsInProgress(new Set),pe(!1)}))}),[J,d,h,be,we,k,B]),xe=(0,r.useCallback)((e=>{let{updateWidgetManager:t}=e;(0,p.hX)(M)||(0,p.hX)(W)||(J(null),M.empty(),d.deleteFile(W),ne(Y),ae(Y),B(null),t&&h.setFileUploaderStateValue(n,{},{fromUi:!0},k),le(!1),(0,p.se)(q)&&URL.revokeObjectURL(q))}),[W,q,d,M,n,h,k,ae,J,B]);(0,r.useEffect)((()=>{if((0,p.hX)(we))return;const e=new u.o;return e.manageFormClearListener(h,we,(()=>{xe({updateWidgetManager:!0})})),()=>e.disconnect()}),[we,xe,h]);const Ce=(0,r.useCallback)((()=>{if(null===F.current)return;const e=i.A.create({container:F.current,waveColor:q?(0,f.au)(U.colors.fadedText40,U.colors.secondaryBg):U.colors.primary,progressColor:U.colors.bodyText,height:(0,f.BY)(U.sizes.largestElementHeight)-8,barWidth:4,barGap:4,barRadius:8,cursorWidth:0,url:null!==q&&void 0!==q?q:void 0});e.on("timeupdate",(e=>{ne(Z(1e3*e))})),e.on("pause",(()=>{ee()}));const t=e.registerPlugin(l.A.create({scrollingWaveform:!1,renderRecordedAudio:!0}));return t.on("record-end",(async e=>{ve(e)})),t.on("record-progress",(e=>{ae(Z(e))})),z(e),O(t),()=>{e&&e.destroy(),t&&t.destroy()}}),[ve]);(0,r.useEffect)((()=>Ce()),[Ce]),(0,r.useEffect)((()=>{c()(I,U)||null===M||void 0===M||M.setOptions({waveColor:q?(0,f.au)(U.colors.fadedText40,U.colors.secondaryBg):U.colors.primary,progressColor:U.colors.bodyText})}),[U,I,q,M]);const je=(0,r.useCallback)((()=>{M&&(M.playPause(),le(!0),ee())}),[M]),ke=(0,r.useCallback)((async()=>{let e=_;de||(await navigator.mediaDevices.getUserMedia({audio:!0}).then((()=>l.A.getAvailableAudioDevices().then((t=>{if(D(t),t.length>0){const{deviceId:n}=t[0];G(n),e=n}})))).catch((e=>{se(!0)})),ce(!0)),X&&e&&M&&(M.setOptions({waveColor:U.colors.primary}),q&&xe({updateWidgetManager:!1}),X.startRecording({deviceId:e}).then((()=>{ee()})))}),[_,X,U,M,q,xe,de]),Se=(0,r.useCallback)((()=>{X&&(X.stopRecording(),null===M||void 0===M||M.setOptions({waveColor:(0,f.au)(U.colors.fadedText40,U.colors.secondaryBg)}))}),[X,M,U]),Ae=A(q,"recording.wav"),Ue=Boolean(null===X||void 0===X?void 0:X.isRecording()),Ie=Boolean(null===M||void 0===M?void 0:M.isPlaying()),Re=Ue||Ie,Pe=!Ue&&!q&&!oe,Ee=oe||Pe||me,Te=S||oe;return(0,H.jsxs)(R,{className:"stAudioInput","data-testid":"stAudioInput",children:[(0,H.jsx)(x.L,{label:n.label,disabled:Te,labelVisibility:(0,p.yv)(null===(t=n.labelVisibility)||void 0===t?void 0:t.value),children:n.help&&(0,H.jsx)(N,{children:(0,H.jsx)(w.A,{content:n.help,placement:v.W.TOP})})}),(0,H.jsxs)(P,{children:[(0,H.jsxs)(g.A,{isFullScreen:!1,disableFullscreenMode:!0,target:P,children:[q&&(0,H.jsx)(g.K,{label:"Download as WAV",icon:o.n,onClick:()=>Ae()}),W&&(0,H.jsx)(g.K,{label:"Clear recording",icon:s.e,onClick:()=>xe({updateWidgetManager:!0})})]}),(0,H.jsx)(ue,{isRecording:Ue,isPlaying:Ie,isUploading:ge,isError:me,recordingUrlExists:Boolean(q),startRecording:ke,stopRecording:Se,onClickPlayPause:je,onClear:()=>{xe({updateWidgetManager:!1}),ye(!1)},disabled:Te}),(0,H.jsxs)(E,{children:[me&&(0,H.jsx)(he,{}),Pe&&(0,H.jsx)($,{}),oe&&(0,H.jsx)(K,{}),(0,H.jsx)(T,{"data-testid":"stAudioInputWaveSurfer",ref:F,show:!Ee})]}),(0,H.jsx)(L,{isPlayingOrRecording:Re,"data-testid":"stAudioInputWaveformTimeCode",children:ie?te:re})]})]})},ye=(0,r.memo)(me)},35526:(e,t,n)=>{n.d(t,{Z:()=>a});var r=n(58878);const a=e=>{const t=(0,r.useRef)();return(0,r.useEffect)((()=>{t.current=e}),[e]),t.current}}}]);